<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="google-adsense-account" content="ca-pub-9634304134787821">
  <title>Minecraft Skin Overlay Merger</title>

  <!-- Modern font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1020; --panel:#0f1724; --muted:#9aa4d6; --accent:#6de39b;
      --accent-2:#7bf0c0; --danger:#ff6b6b; --light:#eef1ff; --glass:rgba(255,255,255,0.04);
      --glass-2:rgba(255,255,255,0.02);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 70% -10%, #152038 0%, var(--bg) 60%) fixed;color:var(--light);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}

    /* App shell */
    .app{max-width:1100px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 360px;gap:20px}
    @media(max-width:980px){.app{grid-template-columns:1fr}}

    /* Left area */
    .panel{
      background:linear-gradient(180deg,var(--glass),var(--glass-2));border-radius:18px;padding:20px;border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(8px);box-shadow:0 8px 40px rgba(3,6,18,0.6);
    }
    header.app-header{display:flex;align-items:center;gap:14px;margin-bottom:8px}
    .logo{width:46px;height:46px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 6px 18px rgba(109,227,155,0.12);font-weight:800;color:#06202a}
    h1{font-size:18px;margin:0}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

    .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:14px}
    @media(max-width:720px){.cards{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.04);display:flex;gap:12px;align-items:center}
    .thumb{width:120px;height:120px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);display:grid;place-items:center;background:linear-gradient(135deg,rgba(255,255,255,0.01),rgba(255,255,255,0.02));overflow:hidden;position:relative}
    .thumb img{max-width:100%;max-height:100%;image-rendering:pixelated;cursor:pointer;display:block}
    .meta{flex:1}
    .note{color:var(--muted);font-size:13px}

    /* custom file button */
    .file-btn{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:var(--light);font-weight:600}
    .file-btn svg{width:20px;height:20px;color:var(--light);opacity:1}
    input[type=file]{display:none}

    /* Controls - modern pills */
    .controls{display:flex;justify-content:space-between;align-items:center;margin-top:18px;gap:10px}
    .left-controls{display:flex;gap:10px;align-items:center}
    .pill{display:inline-flex;gap:10px;align-items:center;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);font-weight:600;color:var(--muted)}
    .pill input[type=checkbox]{width:16px;height:16px}

    .actions{display:flex;gap:10px}
    .btn-primary{background:linear-gradient(180deg,var(--accent-2),var(--accent));color:#04211a;border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(58,200,110,0.12);transition:transform .12s ease}
    .btn-primary:hover{transform:translateY(-2px)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:12px;color:var(--muted);cursor:pointer}

    footer.panel-foot{margin-top:14px;color:var(--muted);font-size:13px}

    /* Right preview area */
    .preview-panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:18px;padding:16px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:12px;align-items:stretch}
    .preview-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .preview-stage{background:linear-gradient(180deg,#061021 0%, #071224 60%);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);display:grid;place-items:center}
    canvas#preview-canvas{width:100%;aspect-ratio:16/9;border-radius:10px;display:block}

    /* small controls in preview */
    .preview-controls{display:flex;flex-direction:column;gap:8px}
    .control-row{display:flex;gap:8px;align-items:center}
    .select,.small{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--light);font-size:14px;appearance:none;padding-right:36px;background-repeat:no-repeat;background-position:calc(100% - 12px) center;background-size:12px}
    /* custom caret (white) */
    .select{background-image:url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'%3E%3Cpath fill='none' stroke='%23EEF1FF' stroke-width='2' d='M6 9l6 6 6-6'/%3E%3C/svg%3E");}
    .range{width:140px}

    /* micro UI touches */
    .muted{color:var(--muted)}
    .kbd{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:6px;font-weight:700}

    /* nice focus outlines */
    :focus{outline:none}
    .file-btn:focus,.btn-primary:focus,.btn-ghost:focus{box-shadow:0 0 0 4px rgba(109,227,155,0.08)}

    /* subtle animated header accent */
    .neon{display:inline-block;padding:6px 10px;border-radius:9px;background:linear-gradient(90deg, rgba(109,227,155,0.08), rgba(123,240,192,0.06));border:1px solid rgba(109,227,155,0.12);font-weight:800;color:var(--accent-2)}

  </style>

  <!-- dependencies (three + skinview3d) -->
  <script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
  <script src="https://unpkg.com/skinview3d@2.2.0/bundles/skinview3d.bundle.js"></script>
</head>
<body>

  <div class="app">

    <!-- LEFT: main actions -->
    <div class="panel">
      <header class="app-header">
        <div class="logo">SO</div>
        <div>
          <h1>Minecraft Skin Overlay Merger <span class="neon">Beta</span></h1>
          <div class="subtitle">Client-side merging — no upload. Click thumbnails to preview in 3D.</div>
        </div>
      </header>

      <div class="cards">
        <div class="card">
          <div class="thumb"><img id="img-base" alt="Base preview" title="Click to preview 3D"/></div>
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Base Skin</strong>
              <span class="muted">64×64 recommended</span>
            </div>
            <p class="note">PNG recommended. Old 64×32 also works if both match.</p>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
              <label class="file-btn"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 13l7-7 7 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg><input id="file-base" type="file" accept="image/png"/>Choose</label>
              <button id="clear-base" class="btn-ghost" title="Clear base">Clear</button>
            </div>
            <div id="err-base" class="error" style="display:none;margin-top:8px"></div>
          </div>
        </div>

        <div class="card">
          <div class="thumb"><img id="img-ovr" alt="Overlay preview" title="Click to preview 3D"/></div>
          <div class="meta">
            <div style="display:flex;justify-content:space-between;align-items:center"><strong>Overlay (2nd layer)</strong><span class="muted">Transparent PNG</span></div>
            <p class="note">Only hat/jacket/sleeves/pants pixels recommended (2nd layer).</p>
            <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
              <label class="file-btn"><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 13l7-7 7 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg><input id="file-ovr" type="file" accept="image/png"/>Choose</label>
              <button id="clear-ovr" class="btn-ghost" title="Clear overlay">Clear</button>
            </div>
            <div id="err-ovr" class="error" style="display:none;margin-top:8px"></div>
          </div>
        </div>
      </div>

      <div class="controls" style="margin-top:18px">
        <div class="left-controls">
          <label class="pill"><input id="auto-resize" type="checkbox"/> Auto-resize</label>
          <label class="pill"><input id="preserve-filename" type="checkbox" checked/> Use base filename</label>
        </div>

        <div class="actions">
          <button id="btn-preview" class="btn-ghost">Preview</button>
          <button id="btn-merge" class="btn-primary">Merge & Download</button>
        </div>
      </div>

      <footer class="panel-foot">Tip: Preview uses skinview3d. For strict 2nd-layer overlays, erase base pixels in an editor.</footer>
    </div>

    <!-- RIGHT: preview & options -->
    <aside class="preview-panel">
      <div class="preview-top">
        <div style="display:flex;flex-direction:column">
          <strong style="font-size:14px">Live Preview</strong>
          <span class="muted" style="font-size:13px;margin-top:6px">Click <span class="kbd">Preview</span> or thumbnails to open 3D view</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="file-btn" title="Upload background to preview"><input id="preview-file-bg" type="file" accept="image/*"/>BG</label>
          <select id="bg-fit" class="select small" title="Fit mode"><option value="cover">Cover</option><option value="contain">Contain</option><option value="stretch">Stretch</option></select>
        </div>
      </div>

      <div class="preview-stage">
        <canvas id="preview-canvas" width="1280" height="720"></canvas>
      </div>

      <div class="preview-controls">
        <div id="preview-desc" class="muted" style="margin-top:6px">Ready</div>
        <div class="control-row"><label class="muted">Filter</label><select id="bg-filter" class="select small"><option value="linear">Linear</option><option value="nearest">Nearest</option></select></div>
        <div class="control-row"><label class="muted">Zoom</label><input id="bg-scale" class="range" type="range" min="0.5" max="2" step="0.01" value="1"/></div>
        <div style="display:flex;gap:8px;align-items:center"><button id="preview-bg-remove" class="btn-ghost" style="display:none">Remove BG</button><div id="bg-name" class="muted"></div></div>
      </div>

    </aside>

  </div>

  <!-- hidden compositing canvas -->
  <canvas id="canvas" width="64" height="64" style="display:none"></canvas>

  <!-- Script: behavior kept from previous version (IDs unchanged) -->
  <script>
    /* ---------- Utilities ---------- */
    function fileToImage(file){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error('Failed to read file'));r.onload=()=>{const img=new Image();img.onload=()=>resolve(img);img.onerror=()=>reject(new Error('Failed to decode image'));img.src=r.result};r.readAsDataURL(file);});}
    function fileToDataUrl(file){return new Promise((resolve,reject)=>{const r=new FileReader();r.onerror=()=>reject(new Error('Failed to read file'));r.onload=()=>resolve(r.result);r.readAsDataURL(file);});}
    function ensureImageReady(img){return new Promise(resolve=>{if(!img) return resolve(false); if(img.complete&&img.naturalWidth&&img.naturalHeight) return resolve(true); img.addEventListener('load',()=>resolve(true),{once:true}); img.addEventListener('error',()=>resolve(false),{once:true});});}
    function raf(){return new Promise(r=>requestAnimationFrame(r));}

    /* ---------- State & Elements ---------- */
    let baseImg=null, overlayImg=null, baseName='base';
    let bgDataUrl=null; let viewer=null; let bgTexture=null; let controls=null;

    const imgBase=document.getElementById('img-base');
    const imgOvr=document.getElementById('img-ovr');
    const fileBase=document.getElementById('file-base');
    const fileOvr=document.getElementById('file-ovr');
    const fileCanvas=document.getElementById('canvas');
    const ctx=fileCanvas.getContext('2d',{willReadFrequently:false});
    const autoResize=document.getElementById('auto-resize');
    const preserveFilename=document.getElementById('preserve-filename');
    const btnMerge=document.getElementById('btn-merge');
    const btnPreview=document.getElementById('btn-preview');
    const errBase=document.getElementById('err-base');
    const errOvr=document.getElementById('err-ovr');

    const previewCanvas=document.getElementById('preview-canvas');
    const previewFileBg=document.getElementById('preview-file-bg');
    const previewBgRemove=document.getElementById('preview-bg-remove');
    const bgNameEl=document.getElementById('bg-name');
    const bgFilterSel=document.getElementById('bg-filter');
    const bgFitSel=document.getElementById('bg-fit');
    const bgScaleInp=document.getElementById('bg-scale');
    const previewDesc=document.getElementById('preview-desc');

    function setError(el,msg){ if(!el) return; el.textContent = msg || ''; el.style.display = msg ? 'block' : 'none'; }

    /* drag-drop helpers (visuals handled by CSS on .drop) */
    function wireDrop(zone, kind){ ['dragenter','dragover'].forEach(ev=>zone.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();zone.classList.add('dragover');})); ['dragleave','drop'].forEach(ev=>zone.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();zone.classList.remove('dragover');})); zone.addEventListener('drop', e=>{ handleFiles(kind, e.dataTransfer.files); }); }
    const dropBase=document.getElementById('drop-base')||document.createElement('div'); const dropOvr=document.getElementById('drop-ovr')||document.createElement('div'); // graceful if not present in this layout
    try{ wireDrop(dropBase,'base'); wireDrop(dropOvr,'ovr'); }catch(e){}

    fileBase.addEventListener('change', e=>handleFiles('base', e.target.files));
    fileOvr.addEventListener('change', e=>handleFiles('ovr', e.target.files));

    async function handleFiles(kind, files){ const file = files && files[0]; if(!file) return; if(!file.type||(!file.type.includes('png') && !file.type.includes('image'))){ kind==='base'? setError(errBase,'Please select a PNG.'): setError(errOvr,'Please select a PNG.'); return; } kind==='base'? setError(errBase,''): setError(errOvr,''); if(kind==='base') baseName=(file.name||'base').replace(/\.png$/i,''); try{ const img=await fileToImage(file); if(kind==='base'){ baseImg=img; imgBase.src=img.src; } else { overlayImg=img; imgOvr.src=img.src; } }catch(err){ console.error(err); kind==='base'? setError(errBase,err.message): setError(errOvr,err.message); } }

    /* compositing */
    function compositeToCanvas(){ if(!baseImg || !overlayImg) return null; const bw=baseImg.width,bh=baseImg.height,ow=overlayImg.width,oh=overlayImg.height; fileCanvas.width=bw; fileCanvas.height=bh; ctx.clearRect(0,0,bw,bh); ctx.imageSmoothingEnabled=false; try{ ctx.drawImage(baseImg,0,0,bw,bh); }catch(e){console.warn(e);} if(bw===ow&&bh===oh){ try{ ctx.drawImage(overlayImg,0,0);}catch(e){} } else if(autoResize.checked) ctx.drawImage(overlayImg,0,0,ow,oh,0,0,bw,bh); else { setError(errOvr,`Size mismatch: overlay is ${ow}×${oh}, base is ${bw}×${bh}. Enable "Auto-resize overlay" or provide matching sizes.`); return null; } return fileCanvas; }
    function overlayOnlyDataUrl(){ if(!overlayImg) return null; const tmp=document.createElement('canvas'); tmp.width=overlayImg.width; tmp.height=overlayImg.height; const t=tmp.getContext('2d'); t.imageSmoothingEnabled=false; t.clearRect(0,0,tmp.width,tmp.height); t.drawImage(overlayImg,0,0); return tmp.toDataURL('image/png'); }

    /* skinview3d viewer setup */
    const { SkinViewer, createOrbitControls } = skinview3d;

    function resizeViewerCanvasToDisplaySize(v){ const dpr=Math.min(window.devicePixelRatio||1,2); const cw=Math.max(1,Math.floor(previewCanvas.clientWidth * dpr)); const ch=Math.max(1,Math.floor(previewCanvas.clientHeight * dpr)); previewCanvas.width=cw; previewCanvas.height=ch; if(v && v.renderer){ try{ v.renderer.setSize(cw,ch,false);}catch(e){} } if(v && v.camera){ try{ v.camera.aspect = cw/ch; v.camera.updateProjectionMatrix(); }catch(e){} } }

    function ensureViewer(){ if(viewer) return viewer; viewer = new SkinViewer({ canvas: previewCanvas, width: previewCanvas.width, height: previewCanvas.height, skin: null }); viewer.zoom = 0.95; viewer.fov = 50; // capture controls so we can recenter later
      try{ controls = createOrbitControls(viewer); }catch(e){ controls = null; }
      return viewer; }

    function updateAndApplyBgOptions(tex){ if(!tex || !tex.image) return; const filter = bgFilterSel.value; const fit = bgFitSel.value; const scale = Number(bgScaleInp.value) || 1; tex.magFilter = (filter==='nearest')?THREE.NearestFilter:THREE.LinearFilter; tex.minFilter = (filter==='nearest')?THREE.NearestMipmapNearestFilter:THREE.LinearMipmapLinearFilter; tex.wrapS = tex.wrapT = THREE.ClampToEdgeWrapping; const canvasW=previewCanvas.clientWidth; const canvasH=previewCanvas.clientHeight; const cA=canvasW/canvasH; const iW=tex.image.width; const iH=tex.image.height; const iA=iW/iH; let repeatX=1, repeatY=1; if(fit==='stretch'){ repeatX = scale; repeatY = scale; tex.repeat.set(repeatX, repeatY); tex.center.set(0.5,0.5); tex.offset.set((1-repeatX)/2,(1-repeatY)/2); return; } if(fit==='cover'){ if(iA>cA){ repeatY = 1/scale; repeatX = iA/cA * repeatY; } else { repeatX = 1/scale; repeatY = cA / iA * repeatX; } } else { if(iA>cA){ repeatX = 1/scale; repeatY = cA / iA * repeatX; } else { repeatY = 1/scale; repeatX = iA / cA * repeatY; } } repeatX=Math.max(0.0001,repeatX); repeatY=Math.max(0.0001,repeatY); tex.repeat.set(repeatX,repeatY); tex.center.set(0.5,0.5); tex.offset.set((1-repeatX)/2,(1-repeatY)/2); }

    function applyBackgroundToViewer(v){ if(!v || !v.scene) return; if(!bgDataUrl){ if(v.scene) v.scene.background=null; bgTexture=null; return; } const loader=new THREE.TextureLoader(); loader.load(bgDataUrl, (tex)=>{ try{ tex.encoding = THREE.sRGBEncoding; tex.needsUpdate=true; bgTexture=tex; updateAndApplyBgOptions(tex); v.scene.background=tex; }catch(e){console.error('bg apply err',e);} }, undefined, (err)=>{ console.error('bg load failed', err); }); }

    async function showSkinIn3D(dataUrl, descText){ if(!dataUrl){ alert('No skin available to preview.'); return; } // live right-side preview
      if(previewDesc) previewDesc.textContent='Loading preview...'; await raf(); const v = ensureViewer(); resizeViewerCanvasToDisplaySize(v); applyBackgroundToViewer(v);
      try{
        await v.loadSkin(dataUrl);
        // try to recenter camera & controls so the model stays in view
        try{
          // move camera farther back so the model doesn't start too close
          if(v.camera && typeof v.camera.position.set === 'function') v.camera.position.set(0, 1.4, 4.6);
          // adjust viewer.zoom slightly for a comfortable view
          if(typeof v.zoom !== 'undefined') v.zoom = 0.9;

          if(controls && typeof controls.target !== 'undefined' && typeof controls.update === 'function'){
            controls.target.set(0, 1, 0);
            controls.update();
          } else if(v.camera && typeof v.camera.lookAt === 'function'){
            v.camera.lookAt(0,1,0);
          }
        }catch(e){ console.warn('recenter failed', e); }

        // make sure the preview is visible to the user (scroll into view)
        try{ previewCanvas.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' }); }catch(e){}

        if(previewDesc) previewDesc.textContent = descText || '';
      } catch(err){ console.error('loadSkin error', err); if(previewDesc) previewDesc.textContent = 'Failed to load skin.'; }
    }

    window.addEventListener('resize', ()=>{ if(viewer) resizeViewerCanvasToDisplaySize(viewer); if(bgTexture) updateAndApplyBgOptions(bgTexture); });

    /* modal BG uploader & controls */
    previewFileBg.addEventListener('change', async (e)=>{ const f = e.target.files && e.target.files[0]; if(!f) return; if(!f.type || !f.type.startsWith('image/')){ alert('Please upload an image file.'); return; } try{ bgDataUrl = await fileToDataUrl(f); bgNameEl.textContent = f.name; previewBgRemove.style.display='inline-block'; if(viewer) applyBackgroundToViewer(viewer); }catch(err){ console.error(err); bgDataUrl=null; bgNameEl.textContent=''; previewBgRemove.style.display='none'; } });
    previewBgRemove.addEventListener('click', ()=>{ bgDataUrl=null; bgNameEl.textContent=''; previewFileBg.value=''; previewBgRemove.style.display='none'; if(viewer && viewer.scene) viewer.scene.background=null; bgTexture=null; });

    bgFilterSel.addEventListener('change', ()=>{ if(bgTexture && viewer){ updateAndApplyBgOptions(bgTexture); viewer.scene.background=bgTexture; } });
    bgFitSel.addEventListener('change', ()=>{ if(bgTexture && viewer){ updateAndApplyBgOptions(bgTexture); viewer.scene.background=bgTexture; } });
    bgScaleInp.addEventListener('input', ()=>{ if(bgTexture && viewer){ updateAndApplyBgOptions(bgTexture); viewer.scene.background=bgTexture; } });

    /* click handlers (thumbnail preview + preview button) */
    imgBase.addEventListener('click', async ()=>{ if(!baseImg){ setError(errBase,'Please load a base skin PNG.'); return; } const ok = await ensureImageReady(baseImg); if(!ok){ setError(errBase,'Base image not ready.'); return; } showSkinIn3D(baseImg.src, 'Base skin preview'); });
    imgOvr.addEventListener('click', async ()=>{ if(!overlayImg){ setError(errOvr,'Please load an overlay PNG.'); return; } const ok = await ensureImageReady(overlayImg); if(!ok){ setError(errOvr,'Overlay image not ready.'); return; } showSkinIn3D(overlayOnlyDataUrl(), 'Overlay-only preview (transparent background)'); });
    btnPreview.addEventListener('click', async ()=>{ if(!baseImg){ setError(errBase,'Please load a base skin PNG.'); return; } if(!overlayImg){ setError(errOvr,'Please load an overlay PNG.'); return; } const ok1 = await ensureImageReady(baseImg); const ok2 = await ensureImageReady(overlayImg); if(!ok1 || !ok2){ setError(errBase,'Images are not ready yet.'); return; } const c = compositeToCanvas(); if(!c) return; showSkinIn3D(c.toDataURL('image/png'), 'Merged skin (base + overlay)'); });

    /* merge/download */
    btnMerge.addEventListener('click', ()=>{ setError(errBase,''); setError(errOvr,''); if(!baseImg){ setError(errBase,'Please load a base skin PNG.'); return; } if(!overlayImg){ setError(errOvr,'Please load an overlay PNG.'); return; } const bw=baseImg.width,bh=baseImg.height,ow=overlayImg.width,oh=overlayImg.height; fileCanvas.width=bw; fileCanvas.height=bh; ctx.clearRect(0,0,bw,bh); ctx.imageSmoothingEnabled=false; try{ ctx.drawImage(baseImg,0,0,bw,bh); }catch(e){} if(bw===ow && bh===oh) try{ ctx.drawImage(overlayImg,0,0);}catch(e){} else if(autoResize.checked) ctx.drawImage(overlayImg,0,0,ow,oh,0,0,bw,bh); else { setError(errOvr, `Size mismatch: overlay is ${ow}×${oh}, base is ${bw}×${bh}. Enable "Auto-resize overlay" or provide matching sizes.`); return; } const outName = (preserveFilename.checked? baseName : 'merged_skin') + '.png'; fileCanvas.toBlob(blob=>{ if(!blob) return; const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = outName; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove(); }, 'image/png'); });

    /* clear buttons */
    document.getElementById('clear-base').addEventListener('click', ()=>{ baseImg=null; imgBase.removeAttribute('src'); setError(errBase,''); });
    document.getElementById('clear-ovr').addEventListener('click', ()=>{ overlayImg=null; imgOvr.removeAttribute('src'); setError(errOvr,''); });

  </script>
</body>
</html>
